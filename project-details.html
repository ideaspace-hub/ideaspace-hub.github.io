<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - CollabSpace</title>
    <link rel="icon" type="image/png" href="CollabSpace Logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        :root {
            --dark-bg: #0d1117;
            --main-bg: #161b22;
            --border-color: #30363d;
            --primary-color: #00e6ff; /* Teal/Cyan */
            --accent-color: #8affff;
            --text-color-light: #c9d1d9;
            --text-color-dark: #7d8590;
            --success-color: #238636;
            --error-color: #f85149;
            --button-blue: linear-gradient(45deg, #00e6ff, #0077ff);
            --button-hover-blue: linear-gradient(45deg, #00c0e0, #0056b3);
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--dark-bg); color: var(--text-color-light); padding-top: 70px; }
        .navbar { background: rgba(22, 27, 34, 0.8); color: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; width: 100%; box-sizing: border-box; z-index: 1000; backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        .nav-links { display: flex; align-items: center; }
        .navbar a { color: var(--primary-color); text-decoration: none; margin-left: 25px; font-weight: 500; }
        .navbar strong { font-size: 1.4rem; color: #ffffff; }
        .hamburger { display: none; cursor: pointer; font-size: 24px; color: white; }
        .notification-link { position: relative; }
        #notification-dot { display: none; position: absolute; top: -2px; right: -12px; width: 8px; height: 8px; background-color: #ff4d4d; border-radius: 50%; border: 1px solid var(--dark-bg); }
        .container { max-width: 900px; margin: 40px auto; background: var(--main-bg); padding: 40px; border-radius: 20px; box-shadow: 0 0 30px rgba(0,0,0,0.5); border: 1px solid var(--border-color); }
        h2 { text-align: center; margin-bottom: 30px; color: var(--primary-color); font-size: 2.2rem; }
        h3 { color: var(--accent-color); margin-top: 25px; margin-bottom: 15px; font-size: 1.8rem; }
        .section { margin-bottom: 35px; padding-bottom: 20px; border-bottom: 1px solid rgba(0, 230, 255, 0.1); }
        .section:last-child { border-bottom: none; margin-bottom: 0; }
        .member { background: #24292f; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .member-info strong { color: var(--primary-color); }
        .member-actions button { margin-left: 10px; padding: 6px 12px; font-size: 0.85rem; border-radius: 6px; cursor: pointer; border: none; }
        .btn-report { background-color: #ffc107; color: #000; }
        .btn-remove { background-color: var(--error-color); color: #fff; }
        .warning-status { font-size: 0.8rem; color: #ffc107; font-style: italic; }
        button, .view-cert-btn, .btn-apply, .status-text { 
            padding: 12px 25px; background: var(--button-blue); color: white; font-size: 17px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 230, 255, 0.3); margin-top: 10px; text-decoration: none; display: inline-block; 
        }
        .status-text { background: var(--border-color); color: var(--text-color-dark); cursor: default; box-shadow: none; }
        button:hover, .view-cert-btn:hover, .btn-apply:hover { background: var(--button-hover-blue); transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0, 230, 255, 0.5); }
        button:disabled { background: var(--border-color); cursor: not-allowed; transform: none; box-shadow: none; }
        .completed-banner { color: #28a745; font-weight: bold; margin-bottom: 20px; font-size: 1.2rem; text-align: center; background-color: rgba(40, 167, 69, 0.1); padding: 10px; border-radius: 8px; border: 1px solid #28a745; display: none; }
        .notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 10px; color: white; font-weight: 500; z-index: 3000; opacity: 0; visibility: hidden; transition: all 0.4s ease; }
        .notification.show { opacity: 1; visibility: visible; bottom: 30px; }
        .notification.success { background-color: #28a745; }
        .notification.error { background-color: var(--error-color); }
        #confirmModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000; }
        .confirm-modal-content { background: var(--main-bg); padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); }
        .confirm-modal-content .button-group { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .btn-confirm { background: #28a745; }
        .btn-cancel { background: #6c757d; }
        .help-link { display: block; text-align: right; font-size: 0.9rem; color: var(--primary-color); text-decoration: none; margin-top: 5px; }
        .help-link:hover { text-decoration: underline; }
        .interview-info { background: rgba(0, 123, 255, 0.1); border: 1px solid #007bff; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .interview-info p { margin: 5px 0; }
        .join-btn { display: inline-block; margin-top: 10px; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
        .upgrade-form {
            background: #24292f;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-top: 15px;
            display: flex;
            flex-direction: column;
        }
        .upgrade-form p { color: var(--text-color-dark); margin-top: 0; }
        .upgrade-form input { 
            width: 100%; padding: 10px; 
            background: var(--dark-bg); color: var(--text-color-light);
            border: 1px solid var(--border-color); border-radius: 5px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .upgrade-form button {
            width: 100%;
            margin-top: 10px;
        }
        @media (max-width: 850px) { .nav-links { display: none; flex-direction: column; width: 100%; position: absolute; top: 65px; left: 0; background: rgba(22, 27, 34, 0.95); } .nav-links.active { display: flex; } .hamburger { display: block; } }
    </style>
</head>
<body>
    <div class="navbar">
<div><strong><a href="index.html">üåüCollabSpace</a></strong></div>
        <div class="nav-links" id="navLinks">
            <a href="index.html">Home</a>
            <a href="post-idea.html" >Post Idea</a>
            <a href="apply.html">Apply</a>
            <a href="search.html">Search</a>
            <a id="myProfileLink" href="#">My Profile</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="interview.html">Interview</a>
            <a href="chat.html">Chat</a>
            <a href="history.html">History</a>
            <a href="help.html">Help & Support</a>
            <a href="notifications.html" class="notification-link">Notifications<span id="notification-dot"></span></a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
        <div class="hamburger" onclick="toggleMenu()">
            <i class="fas fa-bars"></i>
        </div>
    </div>

    <div class="container">
        <h2 id="projectTitle">üìÅ Project Details</h2>
        <div id="completionStatus" class="completed-banner"></div>
        <div class="section" id="projectInfo">Loading...</div>
        
        <div class="section" id="userActionSection"></div>

        <div class="section" id="verificationSection" style="display:none;">
            <h3>üèÜ Project Verification & Certification</h3>
            <div id="verificationContent"></div>
        </div>

        <div class="section" id="teamSection">
            <h3>üë• Team Members</h3>
            <div id="membersList"></div>
        </div>
        <div class="section" id="creatorSection" style="display:none;">
            <h3>Project Owner Actions</h3>
            <div id="completeButtonSection">
                <button onclick="openConfirmModal()">‚úÖ Mark Project as Completed</button>
            </div>
        </div>
    </div>

    <div id="confirmModal">
        <div class="confirm-modal-content">
            <p>Are you sure you want to mark this project as completed? This will open it for certificate verification.</p>
            <div class="button-group">
                <button class="btn-confirm" onclick="markAsCompleted()">Confirm</button>
                <button class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
            </div>
        </div>
    </div>
    <div id="notification" class="notification"></div>
    
    <div id="applyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 2000;">
        <div style="background: var(--main-bg); padding: 30px; border-radius: 15px; width: 90%; max-width: 550px; position: relative; border: 1px solid var(--border-color);">
            <span onclick="closeModal()" style="position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.8rem; color: var(--accent-color);">&times;</span>
            <h3>Apply to Project</h3>
            <label for="selectedRole">Select Role:</label>
            <select id="selectedRole" style="width: 100%; padding: 12px; margin-bottom: 20px;"></select>
            <label for="applicationMessage">Message (optional):</label>
            <textarea id="applicationMessage" style="width: 100%; padding: 12px;"></textarea>
            <button class="btn-apply" id="submitAppButton" onclick="submitApplication()">Submit Application</button>
            <div id="modalNotification"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBbTWt0dpw7w6mFJB2yF0olTCh2mBDwbn8", authDomain: "collabspace-6d0af.firebaseapp.com", projectId: "collabspace-6d0af" };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const projectId = new URLSearchParams(window.location.search).get("id");
        let currentUser = null;
        let projectData = null; 
        const notification = document.getElementById("notification");
        let notificationTimeout;
        
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('myProfileLink').href = `profile.html?uid=${user.uid}`;
                listenForUnreadNotifications(user.uid);
                if (projectId) loadProject();
            } else {
                window.location.replace("login.html");
            }
        });

        async function loadProject() {
            try {
                const doc = await db.collection("ideas").doc(projectId).get();
                if (!doc.exists) {
                    document.querySelector('.container').innerHTML = "<h2>‚ùå Project not found.</h2>";
                    return;
                }

                projectData = doc.data();
                const isCreator = (projectData.uid === currentUser.uid);
                let isCurrentUserTeamMember = false;

                document.getElementById("projectTitle").textContent = `üìÅ ${projectData.title}`;
                document.getElementById("projectInfo").innerHTML = `<p>${projectData.description}</p>`;

                const completionStatus = document.getElementById("completionStatus");
                const creatorSection = document.getElementById("creatorSection");
                const verificationSection = document.getElementById('verificationSection');
                const userActionSection = document.getElementById('userActionSection');
                
                const membersSnap = await db.collection("applications").where("projectId", "==", projectId).where("status", "==", "Accepted").get();
                const reportsSnap = await db.collection('inactivityReports').where('projectId', '==', projectId).get();
                const reportsMap = new Map();
                reportsSnap.forEach(doc => reportsMap.set(doc.data().reportedUid, doc.data()));

                const membersList = document.getElementById("membersList");
                membersList.innerHTML = "";
                
                if (!membersSnap.empty) {
                     membersSnap.forEach(memberDoc => {
                        const member = memberDoc.data();
                        if(member.uid === currentUser.uid) { isCurrentUserTeamMember = true; }
                        if (member.uid === projectData.uid) return;
                        
                        let actionsHTML = '';
                        if (isCreator && !projectData.completed) {
                            const report = reportsMap.get(member.uid);
                            if (report && report.status === 'lead_notified') {
                                actionsHTML = `<button class="btn-remove" onclick="removeMember('${memberDoc.id}', '${member.uid}', '${member.name}', '${member.role}')">Remove Member</button>`;
                            } else if (report && (report.status === 'pending' || report.status === 'warned')) {
                                actionsHTML = `<span class="warning-status">Report Pending Admin Review</span>`;
                            } else {
                                actionsHTML = `<button class="btn-report" onclick="reportInactive('${memberDoc.id}', '${member.uid}', '${member.name}')">Report Inactive</button>`;
                            }
                        }
                        membersList.innerHTML += `<div class="member"><div class="member-info"><strong>${member.name}</strong> (${member.role})</div><div class="member-actions">${actionsHTML}</div></div>`;
                    });
                }
                
                if (isCreator) {
                    const creatorName = projectData.creatorName || currentUser.displayName;
                    membersList.innerHTML = `<div class="member"><div class="member-info"><strong>${creatorName}</strong> (Project Lead)</div></div>` + membersList.innerHTML;
                } else if(membersSnap.empty) {
                    membersList.innerHTML = "<p>No team members have been accepted yet.</p>";
                }
                
                if (projectData.completed) {
                    completionStatus.innerText = "‚úÖ This project is marked as completed.";
                    completionStatus.style.display = "block";
                    creatorSection.style.display = "none";
                    
                    if (isCreator || isCurrentUserTeamMember) {
                        verificationSection.style.display = 'block';
                        const verificationContent = document.getElementById('verificationContent');
                        const attempts = projectData.verificationAttempts || 0;
                        const upgradeAttempts = projectData.upgradeAttempts || 0;
                        
                        const appSnap = await db.collection('applications').where('projectId', '==', projectId).where('uid', '==', currentUser.uid).limit(1).get();
                        let appId, appData;
                        let currentTier = 'Uncertified';
                        
                        if (!appSnap.empty) {
                            appId = appSnap.docs[0].id;
                            appData = appSnap.docs[0].data();
                            currentTier = appData.certificateTier || 'Uncertified';
                        } else if (isCreator) { 
                            appId = 'creator';
                            if (projectData.certificateTier) {
                                currentTier = projectData.certificateTier;
                            }
                        }

                        switch (projectData.verificationStatus) {
                            case 'unsubmitted':
                            case 'rejected':
                                 if (attempts < 3) {
                                    verificationContent.innerHTML = `
                                        <p>Submit this project's final GitHub repository link to receive a certificate.</p>
                                        <p>Attempts remaining: <strong>${3 - attempts}</strong></p>
                                        ${projectData.adminFeedback ? `<p style="color:#ffc107;"><strong>Admin Feedback:</strong> ${projectData.adminFeedback}</p>` : ''}
                                        <input type="text" id="repoUrl" placeholder="https://github.com/your-username/your-repo" style="width:100%; padding:10px; border-radius:5px; margin-bottom: 0;">
                                        <a href="how-to-submit.html" target="_blank" class="help-link">How do I get my project link?</a>
                                        <button onclick="submitForVerification(event)" style="margin-top:15px;">Submit for Verification</button>
                                    `;
                                } else {
                                    verificationContent.innerHTML = '<p style="color:var(--error-color);">You have used all verification attempts for this project.</p>';
                                }
                                break;
                            case 'pending':
                                let pendingHTML = '<p>Your submission is pending review by the admin.</p>';
                                if (projectData.interviewDetails && projectData.interviewDetails.link) {
                                    pendingHTML += `
                                        <div class="interview-info">
                                            <p><strong><i class="fas fa-calendar-alt"></i> Interview Scheduled!</strong></p>
                                            <p><strong>Date:</strong> ${projectData.interviewDetails.date}</p>
                                            <p><strong>Time:</strong> ${projectData.interviewDetails.time}</p>
                                            <a href="${projectData.interviewDetails.link}" target="_blank" rel="noopener noreferrer" class="join-btn">Join Interview</a>
                                        </div>
                                    `;
                                }
                                verificationContent.innerHTML = pendingHTML;
                                break;
                            case 'approved':
                                const requestedTier = projectData.requestedTier;
                                let upgradeButtonHTML = '';
                                
                                if (projectData.upgradeRequestStatus === 'pending') {
                                    upgradeButtonHTML = `<p style="color:#ffc107;">Your upgrade request is pending admin review.</p>`;
                                } else if (currentTier === 'Silver' && (projectData.upgradeAttempts || 0) < 3) {
                                    upgradeButtonHTML = `<p>Improve your project to apply for a Gold certificate.</p><p>Attempts remaining: <strong>${3 - (projectData.upgradeAttempts || 0)}</strong></p><button id="upgradeGoldBtn" onclick="showUpgradeForm('Gold')">Apply for Gold Upgrade</button>`;
                                } else if (currentTier === 'Gold' && (projectData.upgradeAttempts || 0) < 3) {
                                    upgradeButtonHTML = `<p>Improve your project to apply for a Platinum certificate.</p><p>Attempts remaining: <strong>${3 - (projectData.upgradeAttempts || 0)}</strong></p><button id="upgradePlatinumBtn" onclick="showUpgradeForm('Platinum')">Apply for Platinum Upgrade</button>`;
                                } else if (currentTier === 'Platinum') {
                                    upgradeButtonHTML = `<p style="color:var(--primary-color);">üèÜ You have the highest certificate tier!</p>`;
                                } else if ((projectData.upgradeAttempts || 0) >= 3) {
                                    upgradeButtonHTML = `<p style="color:var(--error-color);">You have used all upgrade attempts for this project.</p>`;
                                }

                                verificationContent.innerHTML = `
                                    <p style="font-weight:bold;">You earned a <span style="color:${getTierColor(currentTier)};">${currentTier} Certificate</span>!</p>
                                    <a href="certificate.html?appId=${appId}" class="view-cert-btn">View Certificate</a>
                                    <div id="upgradeSection" style="margin-top: 20px;">
                                        ${upgradeButtonHTML}
                                        <div id="upgradeFormContainer"></div>
                                    </div>
                                `;

                                break;
                            case 'failed':
                                verificationContent.innerHTML = '<p style="color:var(--error-color);">Unfortunately, you have used all verification attempts for this project.</p>';
                                break;
                            case 'upgrade_rejected':
                                const requestedTier_rej = projectData.requestedTier;
                                const upgradeAttempts_rej = projectData.upgradeAttempts || 0;
                                let upgradeButtonHTML_rej = '';
                                if (upgradeAttempts_rej < 3) {
                                    upgradeButtonHTML_rej = `<button onclick="showUpgradeForm('${requestedTier_rej}')">Resubmit for ${requestedTier_rej} Upgrade</button>`;
                                }
                                verificationContent.innerHTML = `
                                    <p style="color:#ffc107;"><strong>Upgrade Rejected.</strong> Attempts remaining: <strong>${3 - upgradeAttempts_rej}</strong></p>
                                    <p><strong>Admin Feedback:</strong> ${projectData.adminFeedback || 'None provided.'}</p>
                                    <div id="upgradeSection">
                                        ${upgradeButtonHTML_rej}
                                        <div id="upgradeFormContainer"></div>
                                    </div>
                                `;
                                break;
                            case 'upgrade_failed':
                                verificationContent.innerHTML = '<p style="color:var(--error-color);">You have used all upgrade attempts for this project.</p>';
                                break;
                            default:
                                if (isCreator) {
                                    verificationContent.innerHTML = `<p>This completed project needs to be initialized for the new verification system.</p><button onclick="initializeVerification()">Initialize</button>`;
                                } else {
                                    verificationContent.innerHTML = `<p>This project is complete and awaiting verification setup by the owner.</p>`;
                                }
                                break;
                        }
                    }
                } else if (isCreator) {
                    creatorSection.style.display = "block";
                }

                if (!isCreator && !projectData.completed) {
                    const appSnap = await db.collection('applications').where('uid', '==', currentUser.uid).where('projectId', '==', projectId).get();
                    const hasVacancy = Object.values(projectData.roles).some(c => c > 0);
                    if (!appSnap.empty) {
                        const status = appSnap.docs[0].data().status;
                        userActionSection.innerHTML = (status === 'Accepted') ? `<div class="status-text">‚úÖ Already Joined</div>` : `<div class="status-text">‚è≥ Application Pending</div>`;
                    } else if (!hasVacancy) {
                        userActionSection.innerHTML = `<div class="status-text">‚ùå All Roles Filled</div>`;
                    } else {
                        userActionSection.innerHTML = `<button class="btn-apply" onclick="openApplyModal()">Apply Now</button>`;
                    }
                } else {
                    userActionSection.innerHTML = '';
                }

            } catch (error) { console.error("Error loading project:", error); }
        }
        
        function getTierColor(tier) {
            if (tier === 'Gold') return '#ffc107'; if (tier === 'Platinum') return '#e5e4e2'; return '#c0c0c0';
        }

        function showUpgradeForm(requestedTier) {
            const upgradeSection = document.getElementById('upgradeSection');
            upgradeSection.innerHTML = `
                <div class="upgrade-form">
                    <p>Enter the new GitHub link for your **${requestedTier}** certificate submission.</p>
                    <input type="text" id="upgradeRepoUrl" placeholder="https://github.com/your-username/your-repo">
                    <button class="btn-apply" onclick="submitUpgradeRequest(document.getElementById('upgradeRepoUrl').value, '${requestedTier}')">Submit Upgrade</button>
                </div>
            `;
        }
        
        async function submitUpgradeRequest(repoLink, tier) {
            if (!repoLink || !repoLink.startsWith('http')) {
                return alert("Please enter a valid URL.");
            }
            try {
                const projectRef = db.collection('ideas').doc(projectId);
                const projectDoc = await projectRef.get();
                const upgradeAttempts = (projectDoc.data().upgradeAttempts || 0) + 1;
                const newStatus = (upgradeAttempts >= 3) ? 'upgrade_failed' : 'pending';
                
                await projectRef.update({
                    upgradeRequestStatus: newStatus, upgradeRequestUrl: repoLink, requestedTier: tier, upgradeAttempts: upgradeAttempts
                });
                alert("Upgrade request submitted!");
                loadProject();
            } catch (error) { 
                alert("Failed to submit request."); 
            }
        }
        
        async function reportInactive(appId, reportedUid, reportedUserName) {
            if (!confirm(`Report ${reportedUserName} to admins for inactivity?`)) return;
            try {
                await db.collection('inactivityReports').add({
                    projectId, projectName: projectData.title, applicationId: appId,
                    reporterUid: currentUser.uid, reporterName: currentUser.displayName,
                    reportedUid, reportedUserName, status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                showNotification("Member reported to admin team.", "success");
                loadProject();
            } catch (error) { showNotification("Failed to submit report.", "error"); }
        }

        async function removeMember(appId, memberUid, memberName, role) {
            if (!confirm(`This will remove ${memberName} and add a negative remark to their profile. Are you sure?`)) return;
            try {
                await db.runTransaction(async (t) => {
                    t.update(db.collection('applications').doc(appId), { status: "Removed by Lead" });
                    t.update(db.collection('users').doc(memberUid), {
                        remarks: firebase.firestore.FieldValue.arrayUnion({
                            projectId, projectName: projectData.title,
                            removedAt: firebase.firestore.FieldValue.serverTimestamp(), reason: "Inactivity"
                        })
                    });
                    const reportSnap = await db.collection('inactivityReports').where('applicationId', '==', appId).get();
                    if(!reportSnap.empty) t.update(reportSnap.docs[0].ref, { status: 'resolved_removed' });
                });
                showNotification(`${memberName} has been removed.`, "success");
                loadProject();
            } catch (error) { showNotification("Failed to remove member.", "error"); }
        }
        
        async function markAsCompleted() {
            closeConfirmModal();
            await db.collection("ideas").doc(projectId).update({
                completed: true, verificationStatus: "unsubmitted",
                verificationAttempts: 0, adminFeedback: "", submittedRepoUrl: ""
            });
            showNotification("Project marked as complete!", "success");
            loadProject();
        }

        async function submitForVerification(event) {
            const repoUrl = document.getElementById('repoUrl').value.trim();
            if (!repoUrl.startsWith('http')) return showNotification("Please enter a valid URL.", "error");
            
            const button = event.target;
            button.disabled = true;
            button.textContent = "Submitting...";
            try {
                await db.collection("ideas").doc(projectId).update({
                    verificationStatus: 'pending', submittedRepoUrl: repoUrl, adminFeedback: ''
                });
                showNotification("Submitted for verification!", "success");
                loadProject();
            } catch (error) {
                showNotification("Submission failed.", "error");
                button.disabled = false;
                button.textContent = "Submit for Verification";
            }
        }
        
        function openApplyModal() {
            const modal = document.getElementById("applyModal");
            const roleSelect = document.getElementById("selectedRole");
            roleSelect.innerHTML = "";
            for (const roleName in projectData.roles) {
                if (projectData.roles[roleName] > 0) {
                    const opt = document.createElement("option");
                    opt.value = roleName;
                    opt.textContent = `${roleName} (${projectData.roles[roleName]} available)`;
                    roleSelect.appendChild(opt);
                }
            }
            modal.style.display = "flex";
        }
        
        function closeModal() { document.getElementById("applyModal").style.display = "none"; }

        async function submitApplication() {
            const role = document.getElementById("selectedRole").value;
            if (!role) return;
            const msg = document.getElementById("applicationMessage").value;
            
            await db.collection('applications').add({
                projectId, uid: currentUser.uid, name: currentUser.displayName,
                email: currentUser.email, message: msg, role, status: 'Pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection('users').doc(projectData.uid).collection('notifications').add({
                senderName: currentUser.displayName,
                message: `applied for the role of '${role}' in your project '${projectData.title}'.`,
                link: '/interview.html', read: false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Application Submitted!");
            closeModal();
            loadProject();
        }

        async function generateCertificate(appId) {
            const name = document.getElementById('certName').value.trim();
            if (!name) return alert("Please enter a name.");
            const uniqueCode = 'CS-' + projectId.substring(0, 4) + '-' + currentUser.uid.substring(0, 4) + '-' + Math.random().toString(36).substring(2, 6).toUpperCase();
            let targetAppId = appId;
            if (targetAppId === 'creator') {
                 const newAppRef = db.collection('applications').doc();
                 await newAppRef.set({
                    uid: currentUser.uid, projectId: projectId, name: currentUser.displayName,
                    email: currentUser.email, status: 'Accepted', role: 'Project Lead',
                    certificateName: name, certificateId: uniqueCode
                 });
                 targetAppId = newAppRef.id;
            } else {
                 await db.collection('applications').doc(targetAppId).update({ certificateName: name, certificateId: uniqueCode });
            }
            window.location.href = `certificate.html?appId=${targetAppId}`;
        }

        async function initializeVerification() {
             await db.collection("ideas").doc(projectId).update({ verificationStatus: "unsubmitted", verificationAttempts: 0 });
             loadProject();
        }
        
        function listenForUnreadNotifications(uid) {
            const dot = document.getElementById('notification-dot');
            if (!dot) return;
            db.collection('users').doc(uid).collection('notifications').where('read', '==', false)
              .onSnapshot(snapshot => { if (dot) dot.style.display = snapshot.empty ? 'none' : 'block'; });
        }
        
        function openConfirmModal() { document.getElementById('confirmModal').style.display = 'flex'; }
        function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; }
        
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            notificationTimeout = setTimeout(() => { notification.classList.remove('show'); }, 4000);
        }

        function logout() { auth.signOut().then(() => { window.location.replace("login.html"); }); }
        function toggleMenu() { document.getElementById("navLinks").classList.toggle("active"); }
    </script>
</body>
</html>