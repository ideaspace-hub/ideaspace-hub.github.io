<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - CollabSpace</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: #0a0f24; color: #e0e0e0; }
        .navbar { background: rgba(10, 15, 36, 0.8); color: white; padding: 18px 40px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        .nav-links { display: flex; align-items: center; }
        .navbar a { color: #8affff; text-decoration: none; margin-left: 25px; font-weight: 500; }
        .navbar strong { font-size: 1.4rem; color: #ffffff; }
        .hamburger { display: none; cursor: pointer; font-size: 24px; color: white; }
        .notification-link { position: relative; }
        #notification-dot { display: none; position: absolute; top: -2px; right: -12px; width: 8px; height: 8px; background-color: #ff4d4d; border-radius: 50%; border: 1px solid #0a0f24; }
        .container { max-width: 900px; margin: 40px auto; background: rgba(10, 15, 36, 0.75); padding: 40px; border-radius: 20px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        h2 { text-align: center; margin-bottom: 30px; color: #66ffff; font-size: 2.2rem; }
        h3 { color: #8affff; margin-top: 25px; margin-bottom: 15px; font-size: 1.8rem; }
        .section { margin-bottom: 35px; padding-bottom: 20px; border-bottom: 1px solid rgba(102, 255, 255, 0.1); }
        .section:last-child { border-bottom: none; margin-bottom: 0; }
        .member { background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(102, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .member-info strong { color: #66ffff; }
        .member-actions button { margin-left: 10px; padding: 6px 12px; font-size: 0.85rem; border-radius: 6px; cursor: pointer; border: none; }
        .btn-report { background-color: #ffc107; color: #000; }
        .btn-remove { background-color: #dc3545; color: #fff; }
        .warning-status { font-size: 0.8rem; color: #ffc107; font-style: italic; }
        button, .view-cert-btn, .btn-apply, .status-text { padding: 12px 25px; background: linear-gradient(45deg, #007bff, #00c0ff); color: white; font-size: 17px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); margin-top: 10px; text-decoration: none; display: inline-block; }
        .status-text { background: #555; cursor: default; box-shadow: none; }
        button:hover, .view-cert-btn:hover, .btn-apply:hover { background: linear-gradient(45deg, #0056b3, #008fcc); transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5); }
        button:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        .completed-banner { color: #28a745; font-weight: bold; margin-bottom: 20px; font-size: 1.2rem; text-align: center; background-color: rgba(40, 167, 69, 0.1); padding: 10px; border-radius: 8px; border: 1px solid #28a745; display: none; }
        .notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 10px; color: white; font-weight: 500; z-index: 3000; opacity: 0; visibility: hidden; transition: all 0.4s ease; }
        .notification.show { opacity: 1; visibility: visible; bottom: 30px; }
        .notification.success { background-color: #28a745; }
        .notification.error { background-color: #dc3545; }
        #confirmModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000; }
        .confirm-modal-content { background: rgba(10, 15, 36, 0.9); padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        .confirm-modal-content .button-group { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .btn-confirm { background: linear-gradient(45deg, #28a745, #218838); }
        .btn-cancel { background: linear-gradient(45deg, #6c757d, #5a6268); }
        .help-link { display: block; text-align: right; font-size: 0.9rem; color: #8affff; text-decoration: none; margin-top: 5px; }
        .help-link:hover { text-decoration: underline; }
        .interview-info { background: rgba(0, 123, 255, 0.1); border: 1px solid #007bff; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .interview-info p { margin: 5px 0; }
        .join-btn { display: inline-block; margin-top: 10px; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
        .upgrade-form { background: #24292f; padding: 20px; border-radius: 10px; border: 1px solid rgba(102, 255, 255, 0.2); margin-top: 15px; display: flex; flex-direction: column; }
        .upgrade-form p { color: #c0c0c0; margin-top: 0; }
        .upgrade-form input { width: 100%; padding: 10px; background: #0a0f24; color: #e0e0e0; border: 1px solid rgba(102, 255, 255, 0.3); border-radius: 5px; box-sizing: border-box; margin-bottom: 10px; }
        .upgrade-form button { width: 100%; margin-top: 10px; }
        @media (max-width: 850px) { .nav-links { display: none; flex-direction: column; width: 100%; position: absolute; top: 70px; left: 0; background: rgba(10, 15, 36, 0.95); } .nav-links.active { display: flex; } .hamburger { display: block; } }
    </style>
</head>
<body>
    <div class="navbar">
        <div><strong>üåü CollabSpace</strong></div>
        <div class="nav-links" id="navLinks">
            <a href="index.html">Home</a>
            <a href="post-idea.html" >Post Idea</a>
            <a href="apply.html">Apply</a>
            <a href="search.html">Search</a>
            <a id="myProfileLink" href="#">My Profile</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="interview.html">Interview</a>
            <a href="chat.html">Chat</a>
            <a href="history.html">History</a>
            <a href="help.html">Help & Support</a>
            <a href="notifications.html" class="notification-link">Notifications<span id="notification-dot"></span></a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
        <div class="hamburger" onclick="toggleMenu()">
            <i class="fas fa-bars"></i>
        </div>
    </div>

    <div class="container">
        <h2 id="projectTitle">üìÅ Project Details</h2>
        <div id="completionStatus" class="completed-banner"></div>
        <div class="section" id="projectInfo">Loading...</div>
        
        <div class="section" id="userActionSection"></div>

        <div class="section" id="verificationSection" style="display:none;">
            <h3>üèÜ Project Verification & Certification</h3>
            <div id="verificationContent"></div>
        </div>

        <div class="section" id="teamSection">
            <h3>üë• Team Members</h3>
            <div id="membersList"></div>
        </div>
        <div class="section" id="creatorSection" style="display:none;">
            <h3>Project Owner Actions</h3>
            <div id="completeButtonSection">
                <button onclick="openConfirmModal()">‚úÖ Mark Project as Completed</button>
            </div>
        </div>
    </div>

    <div id="confirmModal">
        <div class="confirm-modal-content">
            <p>Are you sure you want to mark this project as completed? This will open it for certificate verification.</p>
            <div class="button-group">
                <button class="btn-confirm" onclick="markAsCompleted()">Confirm</button>
                <button class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
            </div>
        </div>
    </div>
    <div id="notification" class="notification"></div>
    
    <div id="applyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 2000;">
        <div style="background: rgba(10, 15, 36, 0.95); padding: 30px; border-radius: 15px; width: 90%; max-width: 550px; position: relative;">
            <span onclick="closeModal()" style="position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.8rem; color: #66ffff;">&times;</span>
            <h3>Apply to Project</h3>
            <label for="selectedRole">Select Role:</label>
            <select id="selectedRole" style="width: 100%; padding: 12px; margin-bottom: 20px;"></select>
            <label for="applicationMessage">Message (optional):</label>
            <textarea id="applicationMessage" style="width: 100%; padding: 12px;"></textarea>
            <button class="btn-apply" id="submitAppButton" onclick="submitApplication()">Submit Application</button>
            <div id="modalNotification"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBbTWt0dpw7w6mFJB2yF0olTCh2mBDwbn8", authDomain: "collabspace-6d0af.firebaseapp.com", projectId: "collabspace-6d0af" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const projectId = new URLSearchParams(window.location.search).get("id");
        let currentUser = null;
        let projectData = null; 
        const notification = document.getElementById("notification");
        let notificationTimeout;
        
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('myProfileLink').href = `profile.html?uid=${user.uid}`;
                listenForUnreadNotifications(user.uid);
                if (projectId) loadProject();
            } else {
                window.location.replace("login.html");
            }
        });

        async function loadProject() {
            try {
                const doc = await db.collection("ideas").doc(projectId).get();
                if (!doc.exists) {
                    document.querySelector('.container').innerHTML = "<h2>‚ùå Project not found.</h2>";
                    return;
                }

                projectData = doc.data();
                const isCreator = (projectData.uid === currentUser.uid);
                let isCurrentUserTeamMember = false;

                document.getElementById("projectTitle").textContent = `üìÅ ${projectData.title}`;
                document.getElementById("projectInfo").innerHTML = `<p>${projectData.description}</p>`;

                const completionStatus = document.getElementById("completionStatus");
                const creatorSection = document.getElementById("creatorSection");
                const verificationSection = document.getElementById('verificationSection');
                const userActionSection = document.getElementById('userActionSection');
                
                const membersSnap = await db.collection("applications").where("projectId", "==", projectId).where("status", "==", "Accepted").get();
                const reportsSnap = await db.collection('inactivityReports').where('projectId', '==', projectId).get();
                const reportsMap = new Map();
                reportsSnap.forEach(doc => reportsMap.set(doc.data().reportedUid, doc.data()));

                const membersList = document.getElementById("membersList");
                membersList.innerHTML = "";
                
                if (!membersSnap.empty) {
                     membersSnap.forEach(memberDoc => {
                        const member = memberDoc.data();
                        if(member.uid === currentUser.uid) { isCurrentUserTeamMember = true; }
                        if (member.uid === projectData.uid) return;
                        
                        let actionsHTML = '';
                        if (isCreator && !projectData.completed) {
                            const report = reportsMap.get(member.uid);
                            if (report && report.status === 'lead_notified') {
                                actionsHTML = `<button class="btn-remove" onclick="removeMember('${memberDoc.id}', '${member.uid}', '${member.name}', '${member.role}')">Remove Member</button>`;
                            } else if (report && (report.status === 'pending' || report.status === 'warned')) {
                                actionsHTML = `<span class="warning-status">Report Pending Admin Review</span>`;
                            } else {
                                actionsHTML = `<button class="btn-report" onclick="reportInactive('${memberDoc.id}', '${member.uid}', '${member.name}')">Report Inactive</button>`;
                            }
                        }
                        membersList.innerHTML += `<div class="member"><div class="member-info"><strong>${member.name}</strong> (${member.role})</div><div class="member-actions">${actionsHTML}</div></div>`;
                    });
                }
                
                if (isCreator) {
                    const creatorName = projectData.creatorName || currentUser.displayName;
                    membersList.innerHTML = `<div class="member"><div class="member-info"><strong>${creatorName}</strong> (Project Lead)</div></div>` + membersList.innerHTML;
                } else if(membersSnap.empty) {
                    membersList.innerHTML = "<p>No team members have been accepted yet.</p>";
                }
                
                if (projectData.completed) {
                    completionStatus.innerText = "‚úÖ This project is marked as completed.";
                    completionStatus.style.display = "block";
                    creatorSection.style.display = "none";
                    
                    if (isCreator || isCurrentUserTeamMember) {
                        verificationSection.style.display = 'block';
                        const verificationContent = document.getElementById('verificationContent');
                        const attempts = projectData.verificationAttempts || 0;

                        // ### START OF CRITICAL FIX ###
                        const appSnap = await db.collection('applications').where('projectId', '==', projectId).where('uid', '==', currentUser.uid).where('status', '==', 'Accepted').limit(1).get();
                        let appId = 'creator'; // Default ID for project owner (who might not be in applications)
                        let appData = {};
                        let tier = 'Uncertified';

                        if (!appSnap.empty) {
                            appId = appSnap.docs[0].id;
                            appData = appSnap.docs[0].data();
                            tier = appData.certificateTier || 'Silver'; // Set tier to Silver if approved but tier field is missing
                        }
                        
                        // Fallback for owner if they are not in the application list but have been verified
                        if (isCreator && !appData.certificateTier && projectData.certificateTier) {
                            tier = projectData.certificateTier;
                        }
                        // ### END OF CRITICAL FIX ###
                        
                        switch (projectData.verificationStatus) {
                            case 'unsubmitted':
                            case 'rejected':
                                 if (attempts < 3) {
                                    verificationContent.innerHTML = `
                                        <p>Submit this project's final GitHub repository link to receive a certificate.</p>
                                        <p>Attempts remaining: <strong>${3 - attempts}</strong></p>
                                        ${projectData.adminFeedback ? `<p style="color:#ffc107;"><strong>Admin Feedback:</strong> ${projectData.adminFeedback}</p>` : ''}
                                        <input type="text" id="repoUrl" placeholder="https://github.com/your-username/your-repo" style="width:100%; padding:10px; border-radius:5px; margin-bottom: 0;">
                                        <a href="how-to-submit.html" target="_blank" class="help-link">How do I get my project link?</a>
                                        <button onclick="submitForVerification(event)" style="margin-top:15px;">Submit for Verification</button>
                                    `;
                                } else {
                                    verificationContent.innerHTML = '<p style="color:#dc3545;">You have used all verification attempts for this project.</p>';
                                }
                                break;
                            case 'pending':
                                let pendingHTML = '<p>Your submission is pending review by the admin.</p>';
                                if (projectData.interviewDetails && projectData.interviewDetails.link) {
                                    pendingHTML += `
                                        <div class="interview-info">
                                            <p><strong><i class="fas fa-calendar-alt"></i> Interview Scheduled!</strong></p>
                                            <p><strong>Date:</strong> ${projectData.interviewDetails.date}</p>
                                            <p><strong>Time:</strong> ${projectData.interviewDetails.time}</p>
                                            <a href="${projectData.interviewDetails.link}" target="_blank" rel="noopener noreferrer" class="join-btn">Join Interview</a>
                                        </div>
                                    `;
                                }
                                verificationContent.innerHTML = pendingHTML;
                                break;
                            case 'approved':
                                // This block handles the name input and certificate generation
                                if (appData.certificateId) {
                                    // Certificate already generated, show view/upgrade options
                                    let upgradeHTML = '';
                                    if (projectData.upgradeRequestStatus === 'pending') {
                                        upgradeHTML = `<p style="color:#ffc107;">Your upgrade request is pending admin review.</p>`;
                                    } else if (tier === 'Silver') {
                                        upgradeHTML = `<p>Improve your project to apply for a Gold certificate.</p><button onclick="openUpgradeModal('Gold')">Apply for Gold Upgrade</button>`;
                                    } else if (tier === 'Gold') {
                                        upgradeHTML = `<p>Improve your project to apply for a Platinum certificate.</p><button onclick="openUpgradeModal('Platinum')">Apply for Platinum Upgrade</button>`;
                                    } else {
                                        upgradeHTML = `<p style="color:#66ffff;">üèÜ You have the highest certificate tier!</p>`;
                                    }
                                    verificationContent.innerHTML = `<p style="font-weight:bold;">You earned a <span style="color:${getTierColor(tier)};">${tier} Certificate</span>!</p><a href="certificate.html?appId=${appId}" class="view-cert-btn">View Certificate</a><div style="margin-top: 20px;">${upgradeHTML}</div>`;
                                } else {
                                    // Certificate approved but name not entered, show input box
                                    verificationContent.innerHTML = `<p style="color:#28a745;font-weight:bold;">Project Verified!</p><p>Enter name as it should appear on your certificate:</p><input type="text" id="certName" value="${currentUser.displayName}"><button onclick="generateCertificate('${appId}')">Generate Certificate</button>`;
                                }
                                break;
                            case 'failed':
                                verificationContent.innerHTML = '<p style="color:#dc3545;">Unfortunately, you have used all verification attempts for this project.</p>';
                                break;
                            default:
                                if (isCreator) {
                                    verificationContent.innerHTML = `<p>This completed project needs to be initialized for the new verification system.</p><button onclick="initializeVerification()">Initialize</button>`;
                                } else {
                                    verificationContent.innerHTML = `<p>This project is complete and awaiting verification setup by the owner.</p>`;
                                }
                                break;
                        }
                    }
                } else if (isCreator) {
                    creatorSection.style.display = "block";
                }

                if (!isCreator && !projectData.completed) {
                    const appSnap = await db.collection('applications').where('uid', '==', currentUser.uid).where('projectId', '==', projectId).get();
                    const hasVacancy = Object.values(projectData.roles).some(c => c > 0);
                    if (!appSnap.empty) {
                        const status = appSnap.docs[0].data().status;
                        userActionSection.innerHTML = (status === 'Accepted') ? `<div class="status-text">‚úÖ Already Joined</div>` : `<div class="status-text">‚è≥ Application Pending</div>`;
                    } else if (!hasVacancy) {
                        userActionSection.innerHTML = `<div class="status-text">‚ùå All Roles Filled</div>`;
                    } else {
                        userActionSection.innerHTML = `<button class="btn-apply" onclick="openApplyModal()">Apply Now</button>`;
                    }
                } else {
                    userActionSection.innerHTML = '';
                }

            } catch (error) { console.error("Error loading project:", error); }
        }
        
        function getTierColor(tier) {
            if (tier === 'Gold') return '#ffc107'; if (tier === 'Platinum') return '#e5e4e2'; return '#c0c0c0';
        }
        
        function openUpgradeModal(requestedTier) {
            const newRepoLink = prompt(`To apply for a ${requestedTier} certificate, provide the new GitHub link with your updated project:`);
            if (newRepoLink && newRepoLink.startsWith('http')) submitUpgradeRequest(newRepoLink, requestedTier);
            else if (newRepoLink) alert("Please enter a valid URL.");
        }

        async function submitUpgradeRequest(repoLink, tier) {
            try {
                await db.collection('ideas').doc(projectId).update({
                    upgradeRequestStatus: 'pending', upgradeRequestUrl: repoLink, requestedTier: tier
                });
                alert("Upgrade request submitted!");
                loadProject();
            } catch (error) { alert("Failed to submit request."); }
        }
        
        async function reportInactive(appId, reportedUid, reportedUserName) {
            if (!confirm(`Report ${reportedUserName} to admins for inactivity?`)) return;
            try {
                await db.collection('inactivityReports').add({
                    projectId, projectName: projectData.title, applicationId: appId,
                    reporterUid: currentUser.uid, reporterName: currentUser.displayName,
                    reportedUid, reportedUserName, status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                showNotification("Member reported to admin team.", "success");
                loadProject();
            } catch (error) { showNotification("Failed to submit report.", "error"); }
        }

        async function removeMember(appId, memberUid, memberName, role) {
            if (!confirm(`This will remove ${memberName} and add a negative remark to their profile. Are you sure?`)) return;
            try {
                await db.runTransaction(async (t) => {
                    t.update(db.collection('applications').doc(appId), { status: "Removed by Lead" });
                    t.update(db.collection('users').doc(memberUid), {
                        remarks: firebase.firestore.FieldValue.arrayUnion({
                            projectId, projectName: projectData.title,
                            removedAt: firebase.firestore.FieldValue.serverTimestamp(), reason: "Inactivity"
                        })
                    });
                    const reportSnap = await db.collection('inactivityReports').where('applicationId', '==', appId).get();
                    if(!reportSnap.empty) t.update(reportSnap.docs[0].ref, { status: 'resolved_removed' });
                });
                showNotification(`${memberName} has been removed.`, "success");
                loadProject();
            } catch (error) { showNotification("Failed to remove member.", "error"); }
        }
        
        async function markAsCompleted() {
            closeConfirmModal();
            await db.collection("ideas").doc(projectId).update({
                completed: true, verificationStatus: "unsubmitted",
                verificationAttempts: 0, adminFeedback: "", submittedRepoUrl: ""
            });
            showNotification("Project marked as complete!", "success");
            loadProject();
        }

        async function submitForVerification(event) {
            const repoUrl = document.getElementById('repoUrl').value.trim();
            if (!repoUrl.startsWith('http')) return showNotification("Please enter a valid URL.", "error");
            
            const button = event.target;
            button.disabled = true;
            button.textContent = "Submitting...";
            try {
                await db.collection("ideas").doc(projectId).update({
                    verificationStatus: 'pending', submittedRepoUrl: repoUrl, adminFeedback: ''
                });
                showNotification("Submitted for verification!", "success");
                loadProject();
            } catch (error) {
                showNotification("Submission failed.", "error");
                button.disabled = false;
                button.textContent = "Submit for Verification";
            }
        }
        
        function openApplyModal() {
            const modal = document.getElementById("applyModal");
            const roleSelect = document.getElementById("selectedRole");
            roleSelect.innerHTML = "";
            for (const roleName in projectData.roles) {
                if (projectData.roles[roleName] > 0) {
                    const opt = document.createElement("option");
                    opt.value = roleName;
                    opt.textContent = `${roleName} (${projectData.roles[roleName]} available)`;
                    roleSelect.appendChild(opt);
                }
            }
            modal.style.display = "flex";
        }
        
        function closeModal() { document.getElementById("applyModal").style.display = "none"; }

        async function submitApplication() {
            const role = document.getElementById("selectedRole").value;
            if (!role) return;
            const msg = document.getElementById("applicationMessage").value;
            
            await db.collection('applications').add({
                projectId, uid: currentUser.uid, name: currentUser.displayName,
                email: currentUser.email, message: msg, role, status: 'Pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection('users').doc(projectData.uid).collection('notifications').add({
                senderName: currentUser.displayName,
                message: `applied for the role of '${role}' in your project '${projectData.title}'.`,
                link: '/interview.html', read: false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Application Submitted!");
            closeModal();
            loadProject();
        }

        async function generateCertificate(appId) {
            const name = document.getElementById('certName').value.trim();
            if (!name) return alert("Please enter a name.");
            const uniqueCode = 'CS-' + projectId.substring(0, 4) + '-' + currentUser.uid.substring(0, 4) + '-' + Math.random().toString(36).substring(2, 6).toUpperCase();
            let targetAppId = appId;
            if (targetAppId === 'creator') {
                 const newAppRef = db.collection('applications').doc();
                 await newAppRef.set({
                    uid: currentUser.uid, projectId: projectId, name: currentUser.displayName,
                    email: currentUser.email, status: 'Accepted', role: 'Project Lead',
                    certificateName: name, certificateId: uniqueCode
                 });
                 targetAppId = newAppRef.id;
            } else {
                 await db.collection('applications').doc(targetAppId).update({ certificateName: name, certificateId: uniqueCode });
            }
            window.location.href = `certificate.html?appId=${targetAppId}`;
        }

        async function initializeVerification() {
             await db.collection("ideas").doc(projectId).update({ verificationStatus: "unsubmitted", verificationAttempts: 0 });
             loadProject();
        }
        
        function listenForUnreadNotifications(uid) {
            const dot = document.getElementById('notification-dot');
            if (!dot) return;
            db.collection('users').doc(uid).collection('notifications').where('read', '==', false)
              .onSnapshot(snapshot => { if (dot) dot.style.display = snapshot.empty ? 'none' : 'block'; });
        }
        
        function openConfirmModal() { document.getElementById('confirmModal').style.display = 'flex'; }
        function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; }
        
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            notificationTimeout = setTimeout(() => { notification.classList.remove('show'); }, 4000);
        }

        function logout() { auth.signOut().then(() => { window.location.replace("login.html"); }); }
        function toggleMenu() { document.getElementById("navLinks").classList.toggle("active"); }
    </script>
</body>
</html>
